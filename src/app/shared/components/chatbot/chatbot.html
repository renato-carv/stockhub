<!-- Floating Button (only shown when user is logged in with a team) -->
@if (shouldShow() && !isOpen()) {
  <button
    class="chatbot-toggle"
    (click)="toggleChat()"
    aria-label="Abrir assistente"
  >
    <img src="logistics.svg" alt="Assistente" class="bot-icon" />
  </button>
}

<!-- Chat Window -->
@if (shouldShow() && isOpen()) {
  <div class="chatbot-window">
    <!-- Header -->
    <div class="chatbot-header">
      <div class="header-info">
        <img src="logistics.svg" alt="Assistente" class="header-icon" />
        <div class="header-text">
          <span class="header-title">Assistente StockHub</span>
          <span class="header-status">Online</span>
        </div>
      </div>
      <button class="close-btn" (click)="closeChat()" aria-label="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div class="chatbot-messages" #messagesContainer>
      @for (message of messages(); track message.id) {
        <div class="message" [class.user]="message.role === 'user'" [class.assistant]="message.role === 'assistant'">
          @if (message.role === 'assistant') {
            <div class="message-avatar">
              <img src="logistics.svg" alt="Bot" />
            </div>
          }
          <div class="message-content">
            <p>{{ message.content }}</p>
            <span class="message-time">
              {{ message.timestamp | date:'HH:mm' }}
            </span>
          </div>
        </div>
      }

      @if (isLoading()) {
        <div class="message assistant">
          <div class="message-avatar">
            <img src="logistics.svg" alt="Bot" />
          </div>
          <div class="message-content typing">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Input -->
    <div class="chatbot-input">
      <input
        type="text"
        [(ngModel)]="inputMessage"
        (keydown)="onKeyDown($event)"
        placeholder="Digite sua mensagem..."
        [disabled]="isLoading()"
      />
      <button
        class="send-btn"
        (click)="sendMessage()"
        [disabled]="!inputMessage.trim() || isLoading()"
        aria-label="Enviar"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
}
