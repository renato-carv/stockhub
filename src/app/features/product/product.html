<div class="products-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Produtos</h1>
      <p class="header-subtitle">Gerencie o catálogo de produtos da sua equipe</p>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="openImportModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        Importar
      </button>
      <button class="btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14" />
          <path d="M5 12h14" />
        </svg>
        Novo Produto
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="m7.5 4.27 9 5.15" />
          <path
            d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"
          />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ totalProducts() }}</span>
        <span class="stat-label">Total de Produtos</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon purple">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="12" y1="1" x2="12" y2="23" />
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ formatCurrency(totalValue()) }}</span>
        <span class="stat-label">Valor em Estoque</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon orange">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
          />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ lowStockCount() }}</span>
        <span class="stat-label">Estoque Baixo</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon red">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ outOfStockCount() }}</span>
        <span class="stat-label">Sem Estoque</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-input">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="11" cy="11" r="8" />
        <path d="m21 21-4.3-4.3" />
      </svg>
      <input
        type="text"
        placeholder="Buscar por nome, SKU ou descrição..."
        [ngModel]="searchQuery()"
        (ngModelChange)="onSearchChange($event)"
      />
    </div>

    <select
      class="filter-select"
      [ngModel]="selectedCategory()"
      (ngModelChange)="onCategoryFilterChange($event)"
    >
      <option value="">Todas as categorias</option>
      @for (category of categories(); track category.id) {
      <option [value]="category.id">{{ category.name }}</option>
      }
    </select>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    @if (productService.isLoading()) {
    <div class="loading-state">
      <div class="spinner-large"></div>
      <p>Carregando produtos...</p>
    </div>
    } @else if (productService.products().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="48"
          height="48"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path d="m7.5 4.27 9 5.15" />
          <path
            d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"
          />
          <path d="m3.3 7 8.7 5 8.7-5" />
          <path d="M12 22V12" />
        </svg>
      </div>
      @if (searchQuery() || selectedCategory()) {
      <h3>Nenhum produto encontrado</h3>
      <p>Tente ajustar os filtros de busca</p>
      } @else {
      <h3>Nenhum produto cadastrado</h3>
      <p>Comece adicionando seu primeiro produto</p>
      <button class="btn-primary" (click)="openCreateModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M12 5v14" />
          <path d="M5 12h14" />
        </svg>
        Adicionar Produto
      </button>
      }
    </div>
    } @else {
    <table class="products-table">
      <thead>
        <tr>
          <th>Produto</th>
          <th>SKU</th>
          <th>Categoria</th>
          <th class="text-right">Preço Custo</th>
          <th class="text-right">Preço Venda</th>
          <th class="text-center">Estoque</th>
          <th class="text-center">Status</th>
          <th class="text-center">Ações</th>
        </tr>
      </thead>
      <tbody>
        @for (product of productService.products(); track product.id) {
        <tr>
          <td>
            <div class="product-cell">
              <div class="product-info">
                <span class="product-name">{{ product.name }}</span>
                @if (product.description) {
                <span class="product-description">{{ product.description }}</span>
                }
              </div>
            </div>
          </td>
          <td>
            <span class="sku-badge">{{ product.sku }}</span>
          </td>
          <td>
            @if (product.categoryId) {
            <span class="category-badge" [style.background-color]="getCategoryColor(product.categoryId) + '20'" [style.color]="getCategoryColor(product.categoryId)">{{ getCategoryName(product.categoryId) }}</span>
            } @else {
            <span class="text-muted">—</span>
            }
          </td>
          <td class="text-right">{{ formatCurrency(product.costPrice) }}</td>
          <td class="text-right">{{ formatCurrency(product.salePrice) }}</td>
          <td class="text-center">
            <span class="stock-value">{{ product.currentStock }} {{ product.unit }}</span>
          </td>
          <td class="text-center">
            <span class="status-badge" [class]="getStockStatus(product)">
              {{ getStockStatusLabel(product) }}
            </span>
          </td>
          <td class="text-center">
            <div class="actions-cell">
              <button class="btn-icon" title="Editar" (click)="openEditModal(product)">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M12 20h9" />
                  <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" />
                </svg>
              </button>
              <button class="btn-icon danger" title="Excluir" (click)="openDeleteModal(product)">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M3 6h18" />
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                  <line x1="10" y1="11" x2="10" y2="17" />
                  <line x1="14" y1="11" x2="14" y2="17" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>

    <!-- Paginação -->
    <app-pagination
      [meta]="productService.paginationMeta()"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
    />
    }
  </div>
</div>

<!-- Modal Criar/Editar Produto -->
@if (showModal()) {
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal modal-lg" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeModal()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M18 6L6 18M6 6l12 12" />
      </svg>
    </button>

    <div class="modal-header">
      <div class="modal-icon">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="m7.5 4.27 9 5.15" />
          <path
            d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"
          />
        </svg>
      </div>
      <h2>{{ isEditing() ? 'Editar Produto' : 'Novo Produto' }}</h2>
      <p>
        {{
          isEditing() ? 'Atualize as informações do produto' : 'Preencha as informações do produto'
        }}
      </p>
    </div>

    <form class="modal-form" (ngSubmit)="saveProduct()">
      <div class="form-group">
        <label for="productName">Nome do Produto *</label>
        <input
          type="text"
          id="productName"
          [ngModel]="productName()"
          (ngModelChange)="productName.set($event)"
          name="productName"
          placeholder="Ex: Camiseta Básica"
          required
        />
      </div>

      <div class="form-row-inline">
        <div class="form-group flex-1">
          <label for="productSku">SKU *</label>
          <div class="input-with-button">
            <input
              type="text"
              id="productSku"
              [ngModel]="productSku()"
              (ngModelChange)="productSku.set($event)"
              name="productSku"
              placeholder="CAM-001"
              required
            />
            <button
              type="button"
              class="btn-generate"
              (click)="generateSku()"
              title="Gerar SKU"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                <path d="M21 3v5h-5" />
              </svg>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="productCategory">Categoria</label>
          <div class="select-with-button">
            <select
              id="productCategory"
              [ngModel]="productCategoryId()"
              (ngModelChange)="productCategoryId.set($event)"
              name="productCategory"
            >
              <option [ngValue]="null">Selecione uma categoria</option>
              @for (cat of categories(); track cat.id) {
              <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
            <button
              type="button"
              class="btn-add-category"
              (click)="openCategoryModal()"
              title="Nova categoria"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14" />
                <path d="M5 12h14" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="productDescription">Descrição</label>
        <textarea
          id="productDescription"
          [ngModel]="productDescription()"
          (ngModelChange)="productDescription.set($event)"
          name="productDescription"
          placeholder="Descrição detalhada do produto..."
          rows="2"
        ></textarea>
      </div>

      <div class="form-section">
        <h3>Preços</h3>
        <div class="form-row-inline">
          <div class="form-group flex-1">
            <label for="productCostPrice">Preço de Custo *</label>
            <div class="input-currency">
              <span class="currency-prefix">R$</span>
              <input
                type="number"
                id="productCostPrice"
                [ngModel]="productCostPrice()"
                (ngModelChange)="productCostPrice.set($event)"
                name="productCostPrice"
                placeholder="0,00"
                step="0.01"
                min="0"
                required
              />
            </div>
          </div>

          <div class="form-group flex-1">
            <label for="productSalePrice">Preço de Venda *</label>
            <div class="input-currency">
              <span class="currency-prefix">R$</span>
              <input
                type="number"
                id="productSalePrice"
                [ngModel]="productSalePrice()"
                (ngModelChange)="productSalePrice.set($event)"
                name="productSalePrice"
                placeholder="0,00"
                step="0.01"
                min="0"
                required
              />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>Estoque</h3>
        <div class="form-row-inline">
          <div class="form-group">
            <label for="productUnit">Unidade *</label>
            <select
              id="productUnit"
              [ngModel]="productUnit()"
              (ngModelChange)="productUnit.set($event)"
              name="productUnit"
              required
            >
              <option value="un">Unidade (un)</option>
              <option value="kg">Quilograma (kg)</option>
              <option value="g">Grama (g)</option>
              <option value="l">Litro (l)</option>
              <option value="ml">Mililitro (ml)</option>
              <option value="m">Metro (m)</option>
              <option value="cm">Centímetro (cm)</option>
              <option value="cx">Caixa (cx)</option>
              <option value="pc">Pacote (pc)</option>
            </select>
          </div>

          <div class="form-group flex-1">
            <label for="productMinStock">Estoque Mínimo *</label>
            <input
              type="number"
              id="productMinStock"
              [ngModel]="productMinStock()"
              (ngModelChange)="productMinStock.set($event)"
              name="productMinStock"
              placeholder="0"
              min="0"
              required
            />
          </div>

          <div class="form-group flex-1">
            <label for="productMaxStock">Estoque Máximo</label>
            <input
              type="number"
              id="productMaxStock"
              [ngModel]="productMaxStock()"
              (ngModelChange)="productMaxStock.set($event)"
              name="productMaxStock"
              placeholder="Opcional"
              min="0"
            />
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button
          type="submit"
          class="btn-primary"
          [disabled]="!productName() || !productSku() || productService.isLoading()"
        >
          @if (productService.isLoading()) {
          <div class="spinner"></div>
          Salvando... } @else {
          {{ isEditing() ? 'Salvar Alterações' : 'Criar Produto' }}
          }
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal Confirmar Exclusão -->
@if (showDeleteModal()) {
<div class="modal-overlay" (click)="closeDeleteModal()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon danger">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      </div>
      <h2>Excluir Produto</h2>
      <p>
        Tem certeza que deseja excluir <strong>{{ productToDelete()?.name }}</strong
        >? Esta ação não pode ser desfeita.
      </p>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
      <button
        type="button"
        class="btn-danger"
        (click)="confirmDelete()"
        [disabled]="productService.isLoading()"
      >
        @if (productService.isLoading()) {
        <div class="spinner"></div>
        Excluindo... } @else { Excluir Produto }
      </button>
    </div>
  </div>
</div>
}

<!-- Modal Gerenciar Categorias -->
@if (showCategoryModal()) {
<div class="modal-overlay" (click)="closeCategoryModal()">
  <div class="modal modal-md" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeCategoryModal()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M18 6L6 18M6 6l12 12" />
      </svg>
    </button>

    <div class="modal-header">
      <div class="modal-icon">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z" />
        </svg>
      </div>
      <h2>Nova Categoria</h2>
      <p>Adicione uma nova categoria para organizar seus produtos</p>
    </div>

    <form class="modal-form" (ngSubmit)="saveCategory()">
      <div class="form-group">
        <label for="categoryName">Nome da Categoria *</label>
        <input
          type="text"
          id="categoryName"
          [ngModel]="newCategoryName()"
          (ngModelChange)="newCategoryName.set($event)"
          name="categoryName"
          placeholder="Ex: Eletrônicos"
          required
        />
      </div>

      <div class="form-group">
        <label for="categoryDescription">Descrição</label>
        <input
          type="text"
          id="categoryDescription"
          [ngModel]="newCategoryDescription()"
          (ngModelChange)="newCategoryDescription.set($event)"
          name="categoryDescription"
          placeholder="Ex: Produtos eletrônicos e acessórios"
        />
      </div>

      <div class="form-group">
        <label for="categoryColor">Cor</label>
        <div class="color-picker-row">
          <input
            type="color"
            id="categoryColor"
            [ngModel]="newCategoryColor()"
            (ngModelChange)="newCategoryColor.set($event)"
            name="categoryColor"
            class="color-input"
          />
          <span class="color-preview" [style.background-color]="newCategoryColor()">
            {{ newCategoryName() || 'Preview' }}
          </span>
        </div>
      </div>

      @if (categories().length > 0) {
      <div class="existing-categories">
        <label>Categorias existentes</label>
        <div class="categories-list">
          @for (cat of categories(); track cat.id) {
          <div class="category-item">
            <span class="category-badge" [style.background-color]="(cat.color || '#6366f1') + '20'" [style.color]="cat.color || '#6366f1'">
              {{ cat.name }}
            </span>
            <button type="button" class="btn-icon-sm danger" (click)="deleteCategory(cat.id)" title="Excluir">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          }
        </div>
      </div>
      }

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeCategoryModal()">Fechar</button>
        <button
          type="submit"
          class="btn-primary"
          [disabled]="!newCategoryName() || categoryService.isLoading()"
        >
          @if (categoryService.isLoading()) {
          <div class="spinner"></div>
          Salvando... } @else { Criar Categoria }
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal Importar Produtos -->
@if (showImportModal()) {
<div class="modal-overlay" (click)="closeImportModal()">
  <div class="modal modal-xl" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeImportModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12" />
      </svg>
    </button>

    <div class="modal-header">
      <div class="modal-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
      </div>
      <h2>Importar Produtos</h2>
      <p>Importe produtos em massa a partir de um arquivo CSV</p>
    </div>

    <!-- Step: Upload -->
    @if (importStep() === 'upload') {
    <div class="import-content">
      <div
        class="upload-zone"
        (drop)="onFileDrop($event)"
        (dragover)="onDragOver($event)"
      >
        <input
          type="file"
          id="importFileInput"
          accept=".csv,.xlsx,.xls"
          hidden
          (change)="onFileSelected($event)"
        />
        <label for="importFileInput" class="upload-zone-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          <span class="upload-text">Arraste um arquivo ou clique para selecionar</span>
          <span class="upload-hint">Formatos aceitos: CSV</span>
        </label>
      </div>

      <div class="template-hint">
        <span>Não sabe como formatar o arquivo?</span>
        <button type="button" class="btn-link" (click)="downloadTemplate()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          Baixar template de exemplo
        </button>
      </div>

      <div class="format-info">
        <h4>Formato esperado:</h4>
        <table class="format-table">
          <thead>
            <tr>
              <th>nome *</th>
              <th>sku *</th>
              <th>descrição</th>
              <th>categoria</th>
              <th>unidade</th>
              <th>preço custo</th>
              <th>preço venda</th>
              <th>estoque mínimo</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Camiseta</td>
              <td>CAM-001</td>
              <td>100% algodão</td>
              <td>Vestuário</td>
              <td>un</td>
              <td>25.00</td>
              <td>49.90</td>
              <td>10</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-secondary" (click)="closeImportModal()">Cancelar</button>
    </div>
    }

    <!-- Step: Preview -->
    @if (importStep() === 'preview') {
    <div class="import-stats">
      <div class="stat-item success">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
        <span>{{ validRowsCount }} válidos</span>
      </div>
      @if (invalidRowsCount > 0) {
      <div class="stat-item error">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
        <span>{{ invalidRowsCount }} com erros</span>
      </div>
      <button type="button" class="btn-remove-invalid" (click)="removeInvalidRows()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
        </svg>
        Remover inválidas
      </button>
      }
    </div>

    <div class="preview-table-container">
      <table class="preview-table">
        <thead>
          <tr>
            <th class="col-status"></th>
            <th>Nome</th>
            <th>SKU</th>
            <th>Categoria</th>
            <th>Unidade</th>
            <th>Custo</th>
            <th>Venda</th>
            <th>Est. Min</th>
            <th class="col-actions"></th>
          </tr>
        </thead>
        <tbody>
          @for (row of importData(); track $index; let i = $index) {
          <tr [class.invalid]="!row.isValid">
            <td class="col-status">
              @if (row.isValid) {
              <svg class="status-icon success" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
              </svg>
              } @else {
              <svg class="status-icon error" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [title]="row.errors.join(', ')">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
              </svg>
              }
            </td>
            <td>
              <input
                type="text"
                class="inline-input"
                [class.has-error]="row.errors.includes('Nome é obrigatório')"
                [value]="row.name"
                (change)="updateImportRow(i, 'name', $any($event.target).value)"
              />
            </td>
            <td>
              <input
                type="text"
                class="inline-input"
                [class.has-error]="hasSkuError(row)"
                [value]="row.sku"
                (change)="updateImportRow(i, 'sku', $any($event.target).value)"
              />
            </td>
            <td>
              <select
                class="inline-select"
                [class.has-error]="hasCategoryError(row)"
                [value]="row.categoryId || ''"
                (change)="updateImportRow(i, 'categoryId', $any($event.target).value || undefined)"
              >
                <option value="">Sem categoria</option>
                @for (cat of categories(); track cat.id) {
                <option [value]="cat.id">{{ cat.name }}</option>
                }
              </select>
            </td>
            <td>
              <select
                class="inline-select"
                [value]="row.unit"
                (change)="updateImportRow(i, 'unit', $any($event.target).value)"
              >
                @for (unit of unitOptions; track unit.value) {
                <option [value]="unit.value">{{ unit.value }}</option>
                }
              </select>
            </td>
            <td>
              <input
                type="number"
                class="inline-input inline-input-sm"
                [value]="row.costPrice"
                step="0.01"
                min="0"
                (change)="updateImportRow(i, 'costPrice', parseNumber($any($event.target).value))"
              />
            </td>
            <td>
              <input
                type="number"
                class="inline-input inline-input-sm"
                [value]="row.salePrice"
                step="0.01"
                min="0"
                (change)="updateImportRow(i, 'salePrice', parseNumber($any($event.target).value))"
              />
            </td>
            <td>
              <input
                type="number"
                class="inline-input inline-input-sm"
                [value]="row.minStock"
                min="0"
                (change)="updateImportRow(i, 'minStock', parseInteger($any($event.target).value))"
              />
            </td>
            <td class="col-actions">
              <button type="button" class="btn-icon-sm danger" (click)="removeImportRow(i)" title="Remover">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18M6 6l12 12" />
                </svg>
              </button>
            </td>
          </tr>
          @if (!row.isValid && row.errors.length > 0) {
          <tr class="error-row">
            <td></td>
            <td colspan="8">
              <span class="error-messages">{{ row.errors.join(' • ') }}</span>
            </td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-secondary" (click)="backToUpload()">Voltar</button>
      <button
        type="button"
        class="btn-primary"
        (click)="confirmImport()"
        [disabled]="validRowsCount === 0"
      >
        Importar {{ validRowsCount }} produto{{ validRowsCount !== 1 ? 's' : '' }}
      </button>
    </div>
    }

    <!-- Step: Importing -->
    @if (importStep() === 'importing') {
    <div class="import-progress">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="importProgress()"></div>
      </div>
      <p class="progress-text">Importando produtos... {{ importProgress() }}%</p>
    </div>
    }

    <!-- Step: Done -->
    @if (importStep() === 'done') {
    <div class="import-results">
      <div class="result-icon success">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
      </div>
      <h3>Importação Concluída</h3>
      <div class="result-stats">
        <div class="result-stat success">
          <strong>{{ importResults().success }}</strong>
          <span>importados com sucesso</span>
        </div>
        @if (importResults().errors > 0) {
        <div class="result-stat error">
          <strong>{{ importResults().errors }}</strong>
          <span>falharam</span>
        </div>
        }
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-primary" (click)="closeImportModal()">Concluir</button>
    </div>
    }
  </div>
</div>
}
