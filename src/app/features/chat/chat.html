@if (!isSetupComplete()) {
  <app-setup-required />
} @else {
<div class="chat-page">
  <!-- Mobile overlay backdrop -->
  <div
    class="chat-mobile-overlay"
    [class.active]="mobileSidebarOpen()"
    (click)="closeMobileSidebar()"
  ></div>

  <!-- Sidebar com histórico -->
  <aside class="chat-sidebar" [class.collapsed]="sidebarCollapsed()" [class.mobile-open]="mobileSidebarOpen()">
    <div class="sidebar-header">
      @if (!sidebarCollapsed()) {
        <button class="new-chat-btn-sidebar" (click)="startNewChat(); closeMobileSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          <span>Nova conversa</span>
        </button>
      }
      <button class="toggle-sidebar-btn desktop-only" (click)="toggleSidebar()" [title]="sidebarCollapsed() ? 'Expandir' : 'Recolher'">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          @if (sidebarCollapsed()) {
            <polyline points="9 18 15 12 9 6"></polyline>
          } @else {
            <polyline points="15 18 9 12 15 6"></polyline>
          }
        </svg>
      </button>
      <!-- Mobile close button -->
      <button class="toggle-sidebar-btn mobile-only" (click)="closeMobileSidebar()" title="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18"/>
          <path d="m6 6 12 12"/>
        </svg>
      </button>
    </div>

    <div class="sidebar-content">
      @if (chatService.isLoadingSessions()) {
        <div class="sessions-loading">
          <div class="spinner-small"></div>
          <span>Carregando...</span>
        </div>
      } @else if (chatService.sessions().length === 0) {
        <div class="sessions-empty">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>Nenhuma conversa</span>
        </div>
      } @else {
        <div class="sessions-list">
          @for (session of chatService.sessions(); track session.id) {
            <div
              class="session-item"
              [class.active]="chatService.currentSessionId() === session.id"
              (click)="loadSession(session.id); closeMobileSidebar()"
            >
              <div class="session-info">
                <span class="session-title">{{ session.title || 'Nova conversa' }}</span>
                <span class="session-date">{{ formatSessionDate(session.createdAt) }}</span>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="chat-main">
    <!-- Mobile header -->
    <div class="chat-mobile-header">
      <button class="mobile-history-btn" (click)="toggleMobileSidebar()" aria-label="Histórico">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      </button>
      <span class="mobile-title">Hubi</span>
      <button class="mobile-new-chat-btn" (click)="startNewChat()" aria-label="Nova conversa">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 5v14"></path>
          <path d="M5 12h14"></path>
        </svg>
      </button>
    </div>

    @if (messages().length === 0 && !chatService.currentSessionId()) {
      <!-- Welcome Screen -->
      <div class="welcome-screen">
        <div class="welcome-logo">
          <img src="logistics.svg" alt="Hubi" />
        </div>
        <h1>Como posso ajudar?</h1>
        <p class="welcome-description">
          Sou o Hubi, seu assistente de estoque inteligente. Posso ajudar com informações sobre produtos, movimentações, relatórios e muito mais.
        </p>

        <div class="suggestion-cards">
          <button class="suggestion-card" (click)="sendSuggestion('Quais produtos estão com estoque baixo?')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span>Quais produtos estão com estoque baixo?</span>
          </button>
          <button class="suggestion-card" (click)="sendSuggestion('Mostre o resumo das movimentações de hoje')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            <span>Mostre o resumo das movimentações de hoje</span>
          </button>
          <button class="suggestion-card" (click)="sendSuggestion('Qual é o produto mais vendido?')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="20" x2="12" y2="10"></line>
              <line x1="18" y1="20" x2="18" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
            <span>Qual é o produto mais vendido?</span>
          </button>
          <button class="suggestion-card" (click)="sendSuggestion('Gere um relatório de estoque')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>Gere um relatório de estoque</span>
          </button>
        </div>
      </div>
    } @else {
      <!-- Messages -->
      <div class="messages-container" #messagesContainer (scroll)="onMessagesScroll()">
          <div class="messages-wrapper">
            @for (message of messages(); track message.id) {
              <div class="message" [class.user]="message.role === 'user'" [class.assistant]="message.role === 'assistant'">
                <div class="message-content">
                  @if (message.role === 'assistant') {
                    @if (!message.content && isLoading()) {
                      <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                      </div>
                    } @else {
                      <div class="message-text">
                        <markdown [data]="message.content"></markdown>
                      </div>
                    }
                  } @else {
                    <div class="message-text">
                      <p>{{ message.content }}</p>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Scroll to bottom button -->
          @if (showScrollButton()) {
            <button class="scroll-to-bottom" (click)="scrollToBottomClick()" aria-label="Ir para o final">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          }
      </div>
    }

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-container">
        <textarea
          #inputField
          [(ngModel)]="inputMessage"
          (keydown)="onKeyDown($event)"
          placeholder="Envie uma mensagem para o Hubi..."
          [disabled]="isLoading()"
          rows="1"
        ></textarea>
        <button
          class="send-btn"
          (click)="sendMessage()"
          [disabled]="!inputMessage.trim() || isLoading()"
          aria-label="Enviar mensagem"
        >
          @if (isLoading()) {
            <div class="btn-spinner"></div>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          }
        </button>
      </div>
      <p class="input-disclaimer">Hubi pode cometer erros. Verifique informações importantes.</p>
    </div>
  </main>
</div>
}