<div class="reports-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Relatórios</h1>
      <p class="header-subtitle">Gere relatórios e exporte dados do seu estoque</p>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="exportXLSX()" [disabled]="isGenerating()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
          <polyline points="14 2 14 8 20 8" />
          <path d="M8 13h2" />
          <path d="M8 17h2" />
          <path d="M14 13h2" />
          <path d="M14 17h2" />
        </svg>
        Exportar XLSX
      </button>
      <button class="btn-primary" (click)="exportPDF()" [disabled]="isGenerating()">
        @if (isGenerating()) {
          <div class="spinner"></div>
          Gerando...
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
            <polyline points="14 2 14 8 20 8" />
            <path d="M12 18v-6" />
            <path d="m9 15 3 3 3-3" />
          </svg>
          Exportar PDF
        }
      </button>
    </div>
  </div>

  <!-- AI Coming Soon Banner -->
  <div class="ai-banner">
    <div class="ai-banner-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a4 4 0 0 1 4 4v1a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4Z" />
        <path d="M12 11v4" />
        <path d="M8 15h8" />
        <path d="m9 19-1 3" />
        <path d="m15 19 1 3" />
        <circle cx="12" cy="19" r="2" />
      </svg>
    </div>
    <div class="ai-banner-content">
      <h3>Insights com IA em breve!</h3>
      <p>Estamos trabalhando para trazer análises inteligentes, previsões de demanda e recomendações automáticas para otimizar seu estoque.</p>
    </div>
  </div>

  <div class="reports-layout">
    <!-- Sidebar - Tipos de Relatório -->
    <aside class="reports-sidebar">
      <h3 class="sidebar-title">Tipo de Relatório</h3>
      <nav class="report-nav">
        @for (report of reportTypes; track report.id) {
          <button
            class="report-nav-item"
            [class.active]="selectedReport() === report.id"
            (click)="selectReport(report.id)"
          >
            <div class="nav-icon">
              @if (report.icon === 'trending') {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3v18h18" />
                  <path d="m19 9-5 5-4-4-3 3" />
                </svg>
              } @else if (report.icon === 'inventory') {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m7.5 4.27 9 5.15" />
                  <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                  <path d="m3.3 7 8.7 5 8.7-5" />
                  <path d="M12 22V12" />
                </svg>
              } @else if (report.icon === 'money') {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8" />
                  <path d="M12 18V6" />
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m7.5 4.27 9 5.15" />
                  <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                  <path d="m3.3 7 8.7 5 8.7-5" />
                  <path d="M12 22V12" />
                </svg>
              }
            </div>
            <div class="nav-text">
              <span class="nav-name">{{ report.name }}</span>
              <span class="nav-description">{{ report.description }}</span>
            </div>
          </button>
        }
      </nav>

      <!-- Filtros de Data -->
      <div class="date-filters">
        <h3 class="sidebar-title">Período</h3>
        <div class="date-group">
          <label>Data Inicial</label>
          <input
            type="date"
            [ngModel]="startDate()"
            (ngModelChange)="startDate.set($event); onDateChange()"
          />
        </div>
        <div class="date-group">
          <label>Data Final</label>
          <input
            type="date"
            [ngModel]="endDate()"
            (ngModelChange)="endDate.set($event); onDateChange()"
          />
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="reports-main">
      <!-- Relatório de Movimentações -->
      @if (selectedReport() === 'movements') {
        <div class="report-section">
          <div class="report-header">
            <h2>Relatório de Movimentações</h2>
            <p>Resumo de entradas, saídas e ajustes no período selecionado</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 19V5" />
                  <path d="m5 12 7-7 7 7" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(movementsSummary()?.totalEntries ?? 0) }}</span>
                <span class="stat-label">Total de Entradas</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon red">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14" />
                  <path d="m19 12-7 7-7-7" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(movementsSummary()?.totalExits ?? 0) }}</span>
                <span class="stat-label">Total de Saídas</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                  <path d="M21 3v5h-5" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(movementsSummary()?.totalAdjustments ?? 0) }}</span>
                <span class="stat-label">Total de Ajustes</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3v18h18" />
                  <path d="m19 9-5 5-4-4-3 3" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber((movementsSummary()?.totalEntries ?? 0) + (movementsSummary()?.totalExits ?? 0) + (movementsSummary()?.totalAdjustments ?? 0)) }}</span>
                <span class="stat-label">Total de Movimentações</span>
              </div>
            </div>
          </div>

          <!-- Gráfico de Tendências -->
          <div class="chart-section">
            <h3>Gráfico de Tendências</h3>
            @if (trendData().length === 0) {
              <div class="chart-placeholder">
                <div class="placeholder-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 3v18h18" />
                    <path d="M18 17V9" />
                    <path d="M13 17V5" />
                    <path d="M8 17v-3" />
                  </svg>
                </div>
                <p>Nenhum dado de tendência disponível para o período selecionado</p>
              </div>
            } @else {
              <app-trend-chart [data]="trendData()" [height]="280"></app-trend-chart>
            }
          </div>
        </div>
      }

      <!-- Relatório de Estoque -->
      @if (selectedReport() === 'stock') {
        <div class="report-section">
          <div class="report-header">
            <h2>Relatório de Estoque Atual</h2>
            <p>Visão geral da situação atual do estoque</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m7.5 4.27 9 5.15" />
                  <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                  <path d="m3.3 7 8.7 5 8.7-5" />
                  <path d="M12 22V12" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(stockOverview()?.totalProducts ?? 0) }}</span>
                <span class="stat-label">Total de Produtos</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                  <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(stockOverview()?.activeProducts ?? 0) }}</span>
                <span class="stat-label">Produtos Ativos</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                  <path d="M12 9v4" />
                  <path d="M12 17h.01" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(stockOverview()?.lowStock ?? 0) }}</span>
                <span class="stat-label">Estoque Baixo</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon red">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="m15 9-6 6" />
                  <path d="m9 9 6 6" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(stockOverview()?.outOfStock ?? 0) }}</span>
                <span class="stat-label">Sem Estoque</span>
              </div>
            </div>
          </div>

          <!-- Alertas de Estoque -->
          @if (stockAlerts()?.lowStock?.length || stockAlerts()?.outOfStock?.length) {
            <div class="alerts-section">
              <h3>Alertas de Estoque</h3>

              @if (stockAlerts()?.outOfStock?.length) {
                <div class="alert-group alert-danger">
                  <div class="alert-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10" />
                      <path d="m15 9-6 6" />
                      <path d="m9 9 6 6" />
                    </svg>
                    <span>Produtos sem estoque ({{ stockAlerts()?.outOfStock?.length }})</span>
                  </div>
                  <ul class="alert-list">
                    @for (product of stockAlerts()?.outOfStock; track product.id) {
                      <li>{{ product.name }} <span class="sku">({{ product.sku }})</span></li>
                    }
                  </ul>
                </div>
              }

              @if (stockAlerts()?.lowStock?.length) {
                <div class="alert-group alert-warning">
                  <div class="alert-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                      <path d="M12 9v4" />
                      <path d="M12 17h.01" />
                    </svg>
                    <span>Produtos com estoque baixo ({{ stockAlerts()?.lowStock?.length }})</span>
                  </div>
                  <ul class="alert-list">
                    @for (product of stockAlerts()?.lowStock; track product.id) {
                      <li>
                        {{ product.name }}
                        <span class="sku">({{ product.sku }})</span>
                        <span class="stock-info">- {{ product.currentStock }}/{{ product.minStock }} un.</span>
                      </li>
                    }
                  </ul>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Relatório Financeiro -->
      @if (selectedReport() === 'financial') {
        <div class="report-section">
          <div class="report-header">
            <h2>Relatório Financeiro</h2>
            <p>Análise de valores e custos do estoque</p>
          </div>

          <div class="stats-grid stats-grid-3">
            <div class="stat-card stat-card-large">
              <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8" />
                  <path d="M12 18V6" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatCurrency(financialSummary()?.totalStockValue ?? 0) }}</span>
                <span class="stat-label">Valor Total em Estoque</span>
              </div>
            </div>

            <div class="stat-card stat-card-large">
              <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatCurrency(financialSummary()?.averageCost ?? 0) }}</span>
                <span class="stat-label">Custo Médio por Produto</span>
              </div>
            </div>

            <div class="stat-card stat-card-large">
              <div class="stat-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3v18h18" />
                  <path d="m19 9-5 5-4-4-3 3" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatCurrency(financialSummary()?.averageProductValue ?? 0) }}</span>
                <span class="stat-label">Valor Médio por Produto</span>
              </div>
            </div>
          </div>

          <!-- Produto mais valioso -->
          @if (financialSummary()?.mostValuableProduct) {
            <div class="valuable-products">
              <h3>Produto Mais Valioso em Estoque</h3>
              <div class="products-list">
                <div class="product-item">
                  <span class="product-rank">1</span>
                  <div class="product-info">
                    <span class="product-name">{{ financialSummary()?.mostValuableProduct?.name }}</span>
                    <span class="product-sku">{{ financialSummary()?.mostValuableProduct?.sku }}</span>
                  </div>
                  <div class="product-stock">
                    <span class="stock-qty">{{ financialSummary()?.mostValuableProduct?.quantity }} un.</span>
                  </div>
                  <div class="product-value">
                    <span class="value-amount">{{ formatCurrency(financialSummary()?.mostValuableProduct?.totalValue ?? 0) }}</span>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- Relatório de Produtos -->
      @if (selectedReport() === 'products') {
        <div class="report-section">
          <div class="report-header">
            <h2>Relatório de Produtos</h2>
            <p>Análise detalhada dos produtos cadastrados</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m7.5 4.27 9 5.15" />
                  <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                  <path d="m3.3 7 8.7 5 8.7-5" />
                  <path d="M12 22V12" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(stockOverview()?.totalProducts ?? 0) }}</span>
                <span class="stat-label">Produtos Cadastrados</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber(stockOverview()?.totalItems ?? 0) }}</span>
                <span class="stat-label">Unidades em Estoque</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">-</span>
                <span class="stat-label">Categorias</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect width="7" height="9" x="3" y="3" rx="1" />
                  <rect width="7" height="5" x="14" y="3" rx="1" />
                  <rect width="7" height="9" x="14" y="12" rx="1" />
                  <rect width="7" height="5" x="3" y="16" rx="1" />
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ formatNumber((movementsSummary()?.totalEntries ?? 0) + (movementsSummary()?.totalExits ?? 0)) }}</span>
                <span class="stat-label">Movimentações Totais</span>
              </div>
            </div>
          </div>

          <!-- Curva ABC -->
          <div class="chart-section">
            <h3>Curva ABC (Análise de Pareto)</h3>
            <p class="chart-description">Classificação dos produtos por valor em estoque: A (80% do valor), B (15%), C (5%)</p>
            @if (abcAnalysis()?.summary) {
              <div class="abc-content">
                <app-abc-chart [data]="abcAnalysis()!.summary" [height]="220"></app-abc-chart>
                <div class="abc-total">
                  <span class="abc-total-label">Valor Total em Estoque</span>
                  <span class="abc-total-value">{{ formatCurrency(abcAnalysis()?.totalValue ?? 0) }}</span>
                </div>
              </div>
            } @else {
              <div class="chart-placeholder">
                <div class="placeholder-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
                    <path d="M22 12A10 10 0 0 0 12 2v10z" />
                  </svg>
                </div>
                <p>Nenhum dado disponível para análise ABC</p>
              </div>
            }
          </div>

          <!-- Top Produtos ABC -->
          @if (abcAnalysis()?.products?.length) {
            <div class="abc-products-section">
              <h3>Produtos por Classificação</h3>
              <div class="abc-products-table">
                <div class="table-header">
                  <span class="col-class">Classe</span>
                  <span class="col-name">Produto</span>
                  <span class="col-value">Valor</span>
                  <span class="col-percent">% Total</span>
                </div>
                @for (product of abcAnalysis()!.products.slice(0, 10); track product.id) {
                  <div class="table-row">
                    <span class="col-class">
                      <span class="class-badge" [class]="'class-' + product.classification.toLowerCase()">
                        {{ product.classification }}
                      </span>
                    </span>
                    <span class="col-name">
                      <span class="product-name">{{ product.name }}</span>
                      <span class="product-sku">{{ product.sku }}</span>
                    </span>
                    <span class="col-value">{{ formatCurrency(product.totalValue) }}</span>
                    <span class="col-percent">{{ product.percentageOfTotal.toFixed(1) }}%</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </main>
  </div>
</div>
